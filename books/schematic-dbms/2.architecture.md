---
title: "アーキテクチャ"
---

## DBMS アーキテクチャ

みなさんデータベースとはなんですか？と聞かれたらなんと答えますか？

- データベースはデータベースだよ。
- データの入れ物でしょ？

データベースを勉強する前の筆者はおそらくこう答えていました。
勉強してなかったからとかなんとなく使ってたからという理由はいくつかありますが、根本的によくわからないというのが正直なところでした。

データを格納したりはするけど中身がどう処理されてるのか見えないし、自分で書いたりしないからよくわからないというのが主な要因だと思います。

データベースを調べてみるとデータベース管理システム(以下DBMS)のアーキテクチャを目にすることがあると思います。

![](/images/schematic-dbms/0-architecture.jpg)
*詳説データベース 図1-1 データベース管理システムのアーキテクチャ 引用*

**転送**

|          |                                                                |
|----------|----------------------------------------------------------------|
| クラスタ通信   | クラスタ通信は、複数のデータベースサーバーが協力して作業する際に重要です。                          |
| クライアント通信 | クライアント通信は、データベースへのアクセスを要求するクライアントアプリケーションとデータベースサーバー間の通信を指します。 |

**クエリプロセッサ**

|            |                                              |
|------------|----------------------------------------------|
| クエリパーサ     | クエリパーサは、ユーザーからのクエリを理解し、データベースが理解できる形式に変換します。 |
| クエリオプティマイザ | クエリオプティマイザは、クエリを実行するために最適な方法を選択します。          |

**実行エンジン**

|        |                                                   |
|--------|---------------------------------------------------|
| リモート実行 | リモート実行は、データベースサーバーがクエリを実行し、結果をクライアントに返すプロセスを指します。 |
| ローカル実行 | ローカル実行は、データベースサーバーが自身でクエリを実行し、結果を生成するプロセスです。      |

**ストレージエンジン**

|                |                                                    |
|----------------|----------------------------------------------------|
| トランザクションマネージャー | トランザクションマネージャーは、データベース内でのトランザクションの整合性を確保します。       |
| ロックマネージャー      | ロックマネージャーは、複数のユーザーが同時にデータにアクセスする際の競合を管理します。        |
| アクセスメソッド       | アクセスメソッドは、データベース内のデータに効率的にアクセスするための手法を提供します。       |
| バッファマネージャー     | バッファマネージャーは、データベース内のデータをメモリ内にキャッシュし、アクセス速度を向上させます。 |
| リカバリマネージャー     | リカバリマネージャーは、データベースの障害から回復し、データの完全性を保つ役割を果たします。     |

受け取ったクエリを解析して処理を行うということが書かれており、何となくわかりますがイメージはしにくいですよね。

DBMSのアーキテクチャはクライアント/サーバーモデルが採用されています。
このクライアント/サーバーモデルというのは機能やサービスを提供するサーバと、それを利用するクライアントとを分離し、ネットワーク通信によって接続する、コンピュータネットワークのソフトウェアモデル（ソフトウェアアーキテクチャ）のことです。

これって普段私たちが作っているWebアプリケーションと同じものですよね？

私たちが作っているWebアプリケーションと同じモデルなのであれば、普段我々が触ったり書いたりしている処理と照らし合わせればデータベースの処理もわかりやすいんじゃないでしょうか？

### Webアプリケーション

まずはWebアプリケーションがデータベースからデータを取得する処理を見返してみましょう。

Webアプリケーションにおいてのクライアントはフロントエンドアプリケーションやターミナルなどバックエンドサーバーに対して通信を行うものです。

フロントエンドアプリケーションであればfetchなどAPIクライアントを使用してバックエンドサーバーに通信を行いますし、ターミナルであればcurlなどのクライアントを使用してバックエンドサーバーに対して通信を行うと思います。

そしてサーバーはクライアントから受け取ったリクエストを処理するバックエンドサーバーのことです。
バックエンドサーバーはクライアントから受け取ったリクエストを元に、使用する言語のORMやSQLライブラリを使用して、データベースからデータを取得します。

![](/images/schematic-dbms/1-architecture.jpg)
*Webアプリケーションのクライアント/サーバーモデル*

DBMSのアーキテクチャの各処理をWebアプリケーションのクライアント/サーバーモデルに照らし合わせて見ていきましょう。

まずWebアプリケーションではクライアントからHTTPリクエストがサーバーに対して送られてきます。

DBMSのアーキテクチャ上クライアント通信はこのような説明になっています。

> クライアント通信は、データベースへのアクセスを要求するクライアントアプリケーションとデータベースサーバー間の通信を指します。

Webアプリケーションにおいてはサーバーへのアクセスを要求するクライアントアプリケーションとサーバー間の通信はHTTP通信のことです。
つまり、DBMSのクライアント通信はWebアプリケーションにおいてはHTTP通信と同じようなイメージとして捉えることができます。

![](/images/schematic-dbms/2-architecture.jpg)

次にDBMSのアーキテクチャにおける「クエリプロセッサ」は以下のような説明になっていますが、Webアプリケーションにおいて何に該当するのかを確認してみます。

> クエリパーサは、ユーザーからのクエリを理解し、データベースが理解できる形式に変換します。
> クエリオプティマイザは、クエリを実行するために最適な方法を選択します。

まずWebアプリケーションがHTTPのリクエストを受け取って行うことは、そのリクエストがどのようなものなのかを解析することです。

- どのようなURLでアクセスが来ているのか？
- どのようなメソッドでのアクセスなのか？
- URLのパスを値として使用するのか？
- パスの値が指定した形式や型に一致しているか？
- ボディの値が指定した形式や型に一致しているか？
- etc...

> クエリパーサはユーザーからのクエリを理解し、データベースが理解できる形式に変換します。

同様に、WEBアプリケーションの場合はクライアントからのHTTPリクエストを解析し、サーバーが理解できる形式に変換します。
例えば、JSON形式のリクエストボディを解析してサーバーが扱いやすいデータ構造に変換するような処理です。

> クエリオプティマイザはクエリを実行するために最適な方法を選択します。

WEBアプリケーションの場合はリクエストに基づいて最適な処理方法やエンドポイントの選択が行われます。
例えば、JSON形式のリクエストボディに基づいて、サーバーが適切な処理やデータベースの操作を行う方法を選択するような処理です。

簡潔に言えば、「クエリプロセッサ」の役割はデータベースクエリの処理に特化していますが、WEBアプリケーションの場合はHTTPリクエストの処理に焦点を当てています。両者とも、与えられた入力（クエリまたはリクエスト）を理解し、最適な形式に変換したり、最適な処理方法を選択する点で共通しています。

つまり、WebアプリケーションにおいてはHTTPリクエストの解析がDBMSの「クエリプロセッサ」の処理に該当するということです。

| DBMS       | WEBアプリケーション      |
|------------|------------------|
| クエリパーサ     | リクエストの解析とパース     |
| クエリオプティマイザ | リクエストの最適な処理方法の選択 |

![](/images/schematic-dbms/3-architecture.jpg)

次にDBMSのアーキテクチャにおける「実行エンジン」が、Webアプリケーションにおいて何に該当するのかを確認してみます。

DBMSのアーキテクチャにおいて「実行エンジン」は、以下のような説明でした。

> リモート実行は、データベースサーバーがクエリを実行し、結果をクライアントに返すプロセスを指します。
> ローカル実行は、データベースサーバーが自身でクエリを実行し、結果を生成するプロセスです。

WebアプリケーションはHTTPのリクエストを受け取りその解析が終わった後に行うことは、そのリクエストの情報に応じてクライアントに返すためのレスポンスを構築するための処理を行うことです。
例えば、リクエストの情報に応じてデータベースからデータを取得し、その情報をレスポンスとしてクライアントに返すような処理です。

では、DBMSのアーキテクチャにおける「実行エンジン」と、WEBアプリケーションにおける同等の処理は以下のようになるのではないでしょうか？

> リモート実行は、データベースサーバーがクエリを実行し、結果をクライアントに返します。

WEBアプリケーションでは、クライアントからのリクエストに基づいてサーバーサイドで処理が行われ、その結果がクライアントに返されます。

> ローカル実行は、データベースサーバーが自身でクエリを実行し、その結果を生成します。

WEBアプリケーションのサーバーサイドでは、クライアントからのリクエストを受け取り、データベースからデータを取得してそれをもとにレスポンスを生成します。

両者ともに、サーバーサイドでの処理が主であり、データベースアクセスとクライアントへの結果の返却が含まれています。また、データベースからのデータ取得は、実際のデータベースクエリの実行に相当します。

つまり、Webアプリケーションにおいてはクライアントからのリクエストに基づいてサーバーサイドからレスポンスを返す一連の処理が、DBMSの「実行エンジン」の処理に該当するということです。

| DBMS   | WEBアプリケーション                |
|--------|----------------------------|
| リモート実行 | サーバーサイドの処理                 |
| ローカル実行 | サーバーサイドの処理（データベースからのデータ取得） |

![](/images/schematic-dbms/4-architecture.jpg)

最後にDBMSのアーキテクチャにおける「ストレージエンジン」が、Webアプリケーションにおいて何に該当するのかを確認してみます。

DBMSのアーキテクチャにおいて「ストレージエンジン」は、以下のような説明でした。

> トランザクションマネージャーは、データベース内でのトランザクションの整合性を確保します。
> ロックマネージャーは、複数のユーザーが同時にデータにアクセスする際の競合を管理します。
> アクセスメソッドは、データベース内のデータに効率的にアクセスするための手法を提供します。
> バッファマネージャーは、データベース内のデータをメモリ内にキャッシュし、アクセス速度を向上させます。
> リカバリマネージャーは、データベースの障害から回復し、データの完全性を保つ役割を果たします。

WebアプリケーションはHTTPのリクエストを受け取りその解析が終わった後に行うことは、そのリクエストの情報に応じてクライアントに返すためのレスポンスを構築するための処理を行うことでした。
この処理は単純な処理だけで済むこともあれば、様々な要素を考慮して作成しなければいけないこともあります。

たとえば、データの同期やアクセス速度の向上、障害時の復旧などです。

DBMSの「ストレージエンジン」も同じようなことが記載されていたと思います。

では、DBMSのアーキテクチャにおける「ストレージエンジン」と、WEBアプリケーションにおける同等の処理は以下のようになるのではないでしょうか？

> トランザクションマネージャーはデータベース内でのトランザクションの整合性を確保します。

同様に、WEBアプリケーションでは複数の操作が原子的かつ整合的に実行されるようにトランザクション管理が行われます。
例えば、複数のデータベース操作や外部APIコールなどが一つのトランザクションにまとめられることがあります。

> ロックマネージャーは複数のユーザーが同時にデータにアクセスする際の競合を管理します。

WEBアプリケーションでは、同時に複数のユーザーが同一データやリソースにアクセスする場合、競合を避けるためにロック管理が行われることがあります。
例えば、データの同時更新を防ぐための排他制御が考えられます。

> アクセスメソッドはデータベース内のデータに効率的にアクセスするための手法を提供します。

WEBアプリケーションでは、データベースからのデータアクセスも効率的で最適な方法を選択することが求められます。
これには、クエリの最適化、インデックスの活用などが含まれます。

> バッファマネージャーはデータベース内のデータをメモリ内にキャッシュし、アクセス速度を向上させます。

同様に、WEBアプリケーションではデータのキャッシュ管理が重要です。
例えば、頻繁に参照されるデータをメモリにキャッシュしてアクセス速度を向上させることが考えられます。

> リカバリマネージャーはデータベースの障害から回復し、データの完全性を保つ役割を果たします。

WEBアプリケーションでも、例えばサーバーのクラッシュからの回復やデータの復旧など、障害への対処が求められます。
これは、冗長性やバックアップ、障害への対応策などに関連します。

つまり、DBMSの「ストレージエンジン」の各々の処理は、Webアプリケーションにおいては以下の処理に該当するとういことです。

| DBMS           | WEBアプリケーション   |
|----------------|---------------|
| トランザクションマネージャー | トランザクション管理    |
| ロックマネージャー      | ロック管理         |
| アクセスメソッド       | データアクセス方法の最適化 |
| バッファマネージャー     | キャッシュ管理       |
| リカバリマネージャー     | 障害からの回復       |

![](/images/schematic-dbms/5-architecture.jpg)

DBMSアーキテクチャ上のそれぞれの処理を、WEBアプリケーションでの処理と照らし合わせてみると何となくどういうものなのか理解が深まったのではないでしょうか？

今までよくわからなかったデータベース内部の処理が、普段作成しているWEBアプリケーション処理と同じようなことをしているとわかったと思います。

次は逆にデータベースの処理をWEBアプリケーションでの処理と照らし合わせて、データベースのよくわからない処理を更に深めていきましょう。

### データベース

![](/images/schematic-dbms/6-architecture.jpg)
*DBMSのクライアント/サーバーモデル*
